@page "/approvals"
@inject IUserService UserService
@inject AuthService AuthService
@inject NavigationManager Navigation
@using VehicleRentalManager.Models
@using VehicleRentalManager.Services
// Interactive mode needed for Approve/Revoke button actions to trigger server-side logic.
@rendermode InteractiveServer

<h3>Employees</h3>

@if (!isAuthorized)
{
    <div class="alert alert-danger mb-4">You are not authorized to view this page.</div>
}
else if (isLoading)
{
    <p class="text-muted mb-4">Loading users...</p>
}
else
{
    <!-- Pending Users -->
    <div class="mb-4">
        <h5 class="text-warning mb-3">
            Pending Approval
            <span class="badge bg-warning text-dark ms-2">@pendingUsers.Count</span>
        </h5>

        @if (pendingUsers.Count == 0)
        {
            <div class="alert alert-success mb-0">No pending users.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Registered</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in pendingUsers)
                        {
                            <tr>
                                <td>@user.Name</td>
                                <td>@user.Email</td>
                                <td>@user.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy HH:mm")</td>
                                <td>
                                    <button class="btn btn-sm btn-success" @onclick="() => Approve(user.Id!)">
                                        ✓ Approve
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

            </div>
        }
    </div>

    <!-- Approved Users -->
    <div>
        <h5 class="text-success mb-3">
            Approved Employees
            <span class="badge bg-success ms-2">@approvedUsers.Count</span>
        </h5>

        @if (approvedUsers.Count == 0)
        {
            <div class="alert alert-secondary mb-0">No approved users yet.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Registered</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in approvedUsers)
                        {
                            <tr>
                                <td>@user.Name</td>
                                <td>@user.Email</td>
                                <td>@user.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy HH:mm")</td>
                                <td>@(user.LastLoginAt.HasValue
                                                            ? user.LastLoginAt.Value.ToLocalTime().ToString("MMM dd, yyyy HH:mm")
                                                        : "—")</td>
                                    <td>
                                        <button class="btn btn-sm btn-danger"                            @onclick="() => Revoke(user.Id!)">
                                            ✕ Revoke
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                </div>
            }
        </div>
    }

@code {
    private List<AppUser> pendingUsers = [];
    private List<AppUser> approvedUsers = [];
    private bool isLoading = true;
    private bool isAuthorized = false;

    protected override async Task OnInitializedAsync()
    {
        // Enforce authentication guard; redirect to login if no valid session exists.
        // This prevents unauthorized access to sensitive administrative functions.
        var current = await AuthService.GetCurrentUserAsync();
        if (!current.IsAuthenticated)
        {
            Navigation.NavigateTo("/auth");
            return;
        }

        isAuthorized = true;
        await LoadUsersAsync();
    }

    private async Task LoadUsersAsync()
    {
        isLoading = true;
        // Fetch all users and partition them in memory to avoid multiple database round-trips.
        var all = await UserService.GetAllAsync();
        pendingUsers = all.Where(u => !u.IsApproved).ToList();
        approvedUsers = all.Where(u => u.IsApproved).ToList();
        isLoading = false;
    }

    private async Task Approve(string id)
    {
        await UserService.ApproveAsync(id);
        await LoadUsersAsync();
    }

    private async Task Revoke(string id)
    {
        await UserService.RevokeAsync(id);
        await LoadUsersAsync();
    }
}